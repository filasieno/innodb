# CPS Parser Tests

This directory contains unit tests for the CPS parser using Google Test and tree-sitter with CTest integration.

## Running Tests

### Using CTest (Recommended)

```bash
# Build and run all tests
make run_tests

# Run tests with verbose output
make run_tests_verbose

# Or use ctest directly
ctest --output-on-failure
ctest -V  # verbose
ctest -R ParseTestFiles  # run specific test
```

### Using the test executable directly

```bash
./build/cps_parser_test
./build/cps_parser_test --gtest_filter="*SimpleNamespaceTest*"
```

## Test Data Structure

```
data/
├── input/       # Test input files (.cps)
├── expected/    # Expected S-expression outputs (.expected)
└── actual/      # Actual S-expression outputs (.actual) - generated during test runs
```

## Adding New Tests

To add a new test case:

1. Create a `.cps` file in the `data/input/` directory with your test input
2. Create a corresponding `.expected` file in the `data/expected/` directory with the expected S-expression output

The test framework will automatically discover and run tests for all files in the input directory.

### Example

To test a new CPS construct:

#### 1. Create `data/input/my_feature.cps`

```cps
// Your CPS code here
namespace my_namespace;
```

#### 2. Create `data/expected/my_feature.expected`

```cps
(file top_level_def: (global_namespace_def name: (identifier)))
```

#### 3. Run the tests - your new test will be automatically included

### Debugging Test Failures

When tests fail, the actual output is automatically saved to `data/actual/your_test.actual`. You can compare this with the expected output to see what went wrong:

```bash
diff data/expected/my_test.expected data/actual/my_test.actual
```

### Test Naming

- Test names are derived from the input filenames (without the `.cps` extension)
- Tests are run in alphabetical order
- Each test file gets its own sub-test within the `ParseTestFiles` test suite

### Expected Output Format

The expected files should contain the S-expression representation of the parse tree as generated by tree-sitter's `ts_node_string()` function. You can generate this by:

1. Running `tree-sitter parse your_file.cps` from the cps directory
2. Copying the output to your `.expected` file
3. The test framework normalizes whitespace, so minor formatting differences are handled automatically
